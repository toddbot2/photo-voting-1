<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Voting Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .image-card {
            transition: transform 0.3s;
        }
        .image-card:hover {
            transform: scale(1.02);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            cursor: zoom-in;
            transition: transform 0.3s;
        }
        .modal-content.zoomed {
            cursor: zoom-out;
            transform: scale(1.5);
        }
        .close-btn {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }
        .close-btn:hover {
            color: #ccc;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Landing Page -->
    <div id="landingPage" class="min-h-screen flex items-center justify-center py-8 px-4">
        <div class="max-w-2xl w-full bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">Photo Voting Gallery</h1>
            <p class="text-gray-600 mb-6 text-center">
                Paste your image URLs below (one per line) to create a voting gallery
            </p>
            
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Image URLs:
                </label>
                <textarea 
                    id="urlInput"
                    class="w-full h-64 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-sm"
                    placeholder="https://example.com/image1.jpg
https://example.com/image2.jpg
https://example.com/image3.jpg
..."
                ></textarea>
                <p class="text-xs text-gray-500 mt-2">
                    Tip: You can paste multiple URLs at once, each on a new line
                </p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Or load sample images:
                </label>
                <button 
                    onclick="loadSampleImages()"
                    class="text-blue-600 hover:text-blue-700 text-sm font-medium"
                >
                    Click here to load sample nature photos
                </button>
            </div>

            <button 
                onclick="startVoting()"
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
            >
                Start Voting Gallery
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div id="imageModal" class="modal" onclick="closeModalOnBackground(event)">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <img id="modalImage" class="modal-content" onclick="toggleZoom(event)" alt="Full size image">
    </div>

    <!-- Voting Gallery -->
    <div id="votingGallery" class="hidden min-h-screen py-8 px-4">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Photo Voting Gallery</h1>
                <p id="instructions" class="text-gray-600">
                    Click images to view full size. Select your 1st, 2nd, and 3rd favorite photos below each image.
                </p>
                <p id="counter" class="text-sm text-gray-500 mt-2">
                    Selected: 1st: <span id="first">None</span> | 2nd: <span id="second">None</span> | 3rd: <span id="third">None</span>
                </p>
                <button 
                    onclick="backToLanding()"
                    class="mt-4 text-blue-600 hover:text-blue-700 text-sm font-medium"
                >
                    ‚Üê Back to change images
                </button>
            </div>

            <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Images will be inserted here by JavaScript -->
            </div>

            <div id="submitSection" class="text-center">
                <button 
                    id="submitBtn"
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                    onclick="submitVotes()"
                    disabled
                >
                    Submit My Votes
                </button>
            </div>

            <div id="resultsSection" class="bg-white rounded-lg shadow-md p-6 mt-8 hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Voting Results</h2>
                <div id="leaderboard" class="space-y-4">
                    <!-- Leaderboard will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let images = [];
        let votes = {
            first: null,
            second: null,
            third: null
        };
        let hasVoted = false;
        let results = null;
        let isZoomed = false;

        // Landing page functions
        function loadSampleImages() {
            const sampleUrls = [
                'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800',
                'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=800',
                'https://images.unsplash.com/photo-1426604966848-d7adac402bff?w=800',
                'https://images.unsplash.com/photo-1511593358241-7eea1f3c84e5?w=800',
                'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=800',
                'https://images.unsplash.com/photo-1501594907352-04cda38ebc29?w=800',
            ];
            document.getElementById('urlInput').value = sampleUrls.join('\n');
        }

        function startVoting() {
            const urlInput = document.getElementById('urlInput').value;
            const urls = urlInput.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            if (urls.length === 0) {
                alert('Please enter at least one image URL!');
                return;
            }

            if (urls.length < 3) {
                alert('Please enter at least 3 image URLs for voting to work properly!');
                return;
            }

            images = urls;
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('votingGallery').classList.remove('hidden');
            
            init();
        }

        function backToLanding() {
            if (!hasVoted || confirm('Are you sure? Your current voting session will be reset.')) {
                document.getElementById('votingGallery').classList.add('hidden');
                document.getElementById('landingPage').classList.remove('hidden');
                
                // Reset voting state
                votes = { first: null, second: null, third: null };
                hasVoted = false;
                isZoomed = false;
            }
        }

        // Initialize the app
        async function init() {
            await loadResults();
            renderGallery();
            setupModalKeyboard();
        }

        // Load results from storage
        async function loadResults() {
            try {
                const storedResults = await window.storage.get('photo-votes');
                if (storedResults) {
                    const stored = JSON.parse(storedResults.value);
                    // Check if stored results match current number of images
                    if (stored.first.length === images.length) {
                        results = stored;
                    } else {
                        // Initialize new results if image count changed
                        results = {
                            first: images.map(() => 0),
                            second: images.map(() => 0),
                            third: images.map(() => 0),
                        };
                    }
                } else {
                    results = {
                        first: images.map(() => 0),
                        second: images.map(() => 0),
                        third: images.map(() => 0),
                    };
                }
            } catch (error) {
                results = {
                    first: images.map(() => 0),
                    second: images.map(() => 0),
                    third: images.map(() => 0),
                };
            }
        }

        // Modal functions
        function openModal(index) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = images[index];
            isZoomed = false;
            modalImg.classList.remove('zoomed');
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.remove('active');
            isZoomed = false;
            modalImg.classList.remove('zoomed');
        }

        function closeModalOnBackground(event) {
            if (event.target.id === 'imageModal') {
                closeModal();
            }
        }

        function toggleZoom(event) {
            event.stopPropagation();
            const modalImg = document.getElementById('modalImage');
            isZoomed = !isZoomed;
            if (isZoomed) {
                modalImg.classList.add('zoomed');
            } else {
                modalImg.classList.remove('zoomed');
            }
        }

        function setupModalKeyboard() {
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // Render the gallery
        function renderGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            images.forEach((url, index) => {
                const card = document.createElement('div');
                card.className = 'image-card bg-white rounded-lg shadow-md overflow-hidden';
                
                card.innerHTML = `
                    <div class="relative cursor-pointer" onclick="openModal(${index})">
                        <img src="${url}" alt="Photo ${index + 1}" class="w-full h-64 object-cover">
                        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-10 transition-all flex items-center justify-center">
                            <span class="text-white font-semibold text-lg opacity-0 hover:opacity-100 bg-black bg-opacity-50 px-4 py-2 rounded">
                                Click to view full size
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        ${!hasVoted ? `
                        <div class="space-y-2">
                            <p class="text-xs text-gray-500 mb-2 text-center font-semibold">Select as favorite:</p>
                            <div class="flex gap-2">
                                <button 
                                    onclick="setVote('first', ${index})"
                                    class="flex-1 py-2 px-3 rounded text-sm font-semibold transition-all ${votes.first === index ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}"
                                >
                                    1st
                                </button>
                                <button 
                                    onclick="setVote('second', ${index})"
                                    class="flex-1 py-2 px-3 rounded text-sm font-semibold transition-all ${votes.second === index ? 'bg-gray-400 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}"
                                >
                                    2nd
                                </button>
                                <button 
                                    onclick="setVote('third', ${index})"
                                    class="flex-1 py-2 px-3 rounded text-sm font-semibold transition-all ${votes.third === index ? 'bg-orange-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}"
                                >
                                    3rd
                                </button>
                            </div>
                        </div>
                        ` : `
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ü•á 1st Place:</span>
                                <span class="font-semibold text-yellow-600">${results.first[index]} votes</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ü•à 2nd Place:</span>
                                <span class="font-semibold text-gray-600">${results.second[index]} votes</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">ü•â 3rd Place:</span>
                                <span class="font-semibold text-orange-600">${results.third[index]} votes</span>
                            </div>
                            <div class="pt-2 mt-2 border-t border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-700 font-semibold">Total Score:</span>
                                    <span class="font-bold text-gray-900">${calculateScore(index)}</span>
                                </div>
                            </div>
                        </div>
                        `}
                    </div>
                `;

                gallery.appendChild(card);
            });

            if (hasVoted) {
                showResults();
            }
        }

        function setVote(place, index) {
            if (hasVoted) return;

            // If this image is already selected for another place, remove it
            if (votes.first === index) votes.first = null;
            if (votes.second === index) votes.second = null;
            if (votes.third === index) votes.third = null;

            // Set the new vote
            votes[place] = index;

            updateCounter();
            renderGallery();
        }

        function updateCounter() {
            const getPhotoLabel = (index) => index !== null ? `Photo ${index + 1}` : 'None';
            
            document.getElementById('first').textContent = getPhotoLabel(votes.first);
            document.getElementById('second').textContent = getPhotoLabel(votes.second);
            document.getElementById('third').textContent = getPhotoLabel(votes.third);

            // Enable submit button only if all three votes are cast
            const allVotesCast = votes.first !== null && votes.second !== null && votes.third !== null;
            document.getElementById('submitBtn').disabled = !allVotesCast;
        }

        async function submitVotes() {
            if (votes.first === null || votes.second === null || votes.third === null) {
                alert('Please select your 1st, 2nd, and 3rd favorite images!');
                return;
            }

            // Add votes to results
            results.first[votes.first]++;
            results.second[votes.second]++;
            results.third[votes.third]++;

            try {
                await window.storage.set('photo-votes', JSON.stringify(results));
                hasVoted = true;
                
                document.getElementById('instructions').textContent = 'Thank you for voting! Here are the current results.';
                document.getElementById('counter').classList.add('hidden');
                document.getElementById('submitSection').classList.add('hidden');
                
                renderGallery();
            } catch (error) {
                console.error('Failed to save votes:', error);
                alert('Failed to save your votes. Please try again.');
            }
        }

        function calculateScore(index) {
            // Weight: 1st place = 3 points, 2nd place = 2 points, 3rd place = 1 point
            return (results.first[index] * 3) + (results.second[index] * 2) + (results.third[index] * 1);
        }

        function showResults() {
            const resultsSection = document.getElementById('resultsSection');
            const leaderboard = document.getElementById('leaderboard');
            
            resultsSection.classList.remove('hidden');
            
            const sortedImages = images
                .map((url, index) => ({ 
                    url, 
                    index, 
                    score: calculateScore(index),
                    first: results.first[index],
                    second: results.second[index],
                    third: results.third[index]
                }))
                .sort((a, b) => b.score - a.score);

            leaderboard.innerHTML = sortedImages.map((item, rank) => `
                <div class="border-b border-gray-200 pb-4 ${rank < sortedImages.length - 1 ? 'mb-4' : ''}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-4">
                            <span class="text-3xl font-bold text-gray-400">#${rank + 1}</span>
                            <img src="${item.url}" alt="" class="w-20 h-20 object-cover rounded cursor-pointer" onclick="openModal(${item.index})">
                            <div>
                                <div class="text-gray-900 font-semibold">Photo ${item.index + 1}</div>
                                <div class="text-sm text-gray-500">Total Score: ${item.score} points</div>
                            </div>
                        </div>
                    </div>
                    <div class="ml-20 grid grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-yellow-600 font-semibold">ü•á ${item.first}</div>
                            <div class="text-gray-500">1st place</div>
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600 font-semibold">ü•à ${item.second}</div>
                            <div class="text-gray-500">2nd place</div>
                        </div>
                        <div class="text-center">
                            <div class="text-orange-600 font-semibold">ü•â ${item.third}</div>
                            <div class="text-gray-500">3rd place</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
